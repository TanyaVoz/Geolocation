(()=>{"use strict";(new class{init(){this.renderTimeline()}renderTimeline(){this.timeline=document.createElement("div"),this.timeline.classList.add("timeline"),this.container=document.createElement("div"),this.container.classList.add("container"),this.timeline.appendChild(this.container),this.messageForm=document.createElement("form"),this.messageForm.classList.add("message-form"),this.messageForm.innerHTML="<input id = 'message-input' placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∑–∞–ø–∏—à–∏—Ç–µ –≤–∏–¥–µ–æ –∏–ª–∏ –∞—É–¥–∏–æ'>",this.messageForm.innerHTML+="<div class = 'record-audio'> </div> <div class = 'record-video'> </div>",this.timeline.appendChild(this.messageForm),this.askPosition=document.createElement("form"),this.askPosition.classList.add("ask-position"),this.askPosition.innerHTML="<div> –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ <br> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é <br> –®–∏—Ä–æ—Ç–∞ –∏ –¥–æ–ª–≥–æ—Ç–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é </div> <input id = 'ask-input'> <div class = 'btn-group'> <button class = 'btn cancel-btn'> –û—Ç–º–µ–Ω–∞ </button> <button class = 'btn ok-btn'> OK </button></div>",this.invalidMessage=document.createElement("div"),this.invalidMessage.classList.add("invalid-message"),this.invalidMessage.innerText="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã",document.querySelector("body").appendChild(this.timeline),this.noAudio=document.createElement("div"),this.noAudio.classList.add("no-audio"),this.noAudio.innerHTML="<div class = 'no-audio-text'> –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞, –∫—É–ø–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏–ª–∏ –¥–∞–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–≤—É–∫–æ–∑–∞–ø–∏—Å–∏ </div> <button class = 'btn cancel-btn'> OK </button>",this.noAudio.querySelector(".btn").onclick=()=>this.noAudio.style.display="none",this.timeline.appendChild(this.noAudio),this.messageForm.addEventListener("submit",(e=>{e.preventDefault(),this.publishTextMessage()})),this.messageForm.querySelector(".record-audio").addEventListener("click",(()=>{this.createAudio()})),this.messageForm.querySelector(".record-video").addEventListener("click",(()=>{this.createVideo()}))}getPosition(){navigator.geolocation.getCurrentPosition((e=>this.position={latitude:e.coords.latitude,longtitude:e.coords.longitude}),(()=>this.position=null))}createTextMessage(e,t,i){const s=document.createElement("div");s.classList.add("message"),s.innerHTML=`<div class = 'message-header'> ${(new Date).toLocaleDateString()}, ${(new Date).toLocaleTimeString()} </div> <div class = 'message-text'> ${e} </div> <div class = 'position'> üìç ${t}, ${i} </div>`,this.container.appendChild(s),document.querySelector("#message-input").value=""}publishTextMessage(){this.getPosition(),setTimeout((()=>{this.text=document.querySelector("#message-input").value,this.text&&(this.position?this.createTextMessage(this.text,this.position.latitude,this.position.longtitude):(this.timeline.appendChild(this.askPosition),this.getManualPosition()))}),3e3)}getManualPosition(){this.askPosition.querySelector("#ask-input").addEventListener("input",(()=>{document.querySelector(".invalid-message")&&this.invalidMessage.remove()})),this.askPosition.querySelector(".ok-btn").onclick=e=>{e.preventDefault();const t=this.askPosition.querySelector("#ask-input").value;this.verifyCoords(t)?(this.askPosition.remove(),this.createTextMessage(this.text,this.position.latitude,this.position.longitude)):this.askPosition.appendChild(this.invalidMessage)},this.askPosition.querySelector(".cancel-btn").addEventListener("click",(e=>{e.preventDefault(),this.askPosition.remove()}))}verifyCoords(e){if(/^\[([-+]?)([\d]{1,2})(((\.)(\d+)(,)))(\s*)(([-+]?)([\d]{1,3})((\.)(\d+))?)\]$/.test(e)||/^([-+]?)([\d]{1,2})(((\.)(\d+)(,)))(\s*)(([-+]?)([\d]{1,3})((\.)(\d+))?)$/.test(e)){let t=e.replace("[","");return t=t.split(","),this.position={latitude:Number.parseFloat(t[0]),longitude:Number.parseFloat(t[1])},!0}return!1}recorderTimer(e){let t=0,i=0;setInterval((()=>{i+=1,60===i&&(t+=1,i=0),e.innerText=i<10?`${t}:0${i}`:`${t}:${i}`}),1e3)}async createAudio(){navigator.mediaDevices||(this.noAudio.style.display="block");try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(e){return void(this.noAudio.style.display="block")}this.audioRecorder=document.createElement("div"),this.audioRecorder.classList.add("audio-recorder"),this.audioRecorder.innerHTML="<div class = 'save-record'> </div> <div class = 'record-timer'> 0:00 </div> <div class = 'cancel-record'></div>";const e=new MediaRecorder(this.stream);this.chunks=[],e.addEventListener("start",(()=>{this.messageForm.appendChild(this.audioRecorder),this.recorderTimer(document.querySelector(".record-timer"))})),e.addEventListener("dataavailable",(e=>{this.chunks.push(e.data)})),e.addEventListener("stop",(()=>{this.sourse=URL.createObjectURL(this.chunks[0]);const e=`<audio controls src = '${this.sourse}'> </audio>`;this.getPosition(),setTimeout((()=>{this.createTextMessage(e,this.position.latitude,this.position.longtitude)}),4e3)})),e.start(),this.audioRecorder.querySelector(".save-record").addEventListener("click",(()=>{this.audioRecorder.remove(),e.stop()}))}async createVideo(){navigator.mediaDevices||(this.noAudio.style.display="block");try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(e){return void(this.noAudio.style.display="block")}this.audioRecorder=document.createElement("div"),this.audioRecorder.classList.add("audio-recorder"),this.audioRecorder.innerHTML="<div class = 'save-record'> </div> <div class = 'record-timer'> 0:00 </div> <div class = 'cancel-record'></div>";const e=new MediaRecorder(this.stream);this.chunks=[],e.addEventListener("start",(()=>{this.messageForm.appendChild(this.audioRecorder),this.recorderTimer(document.querySelector(".record-timer"))})),e.addEventListener("dataavailable",(e=>{this.chunks.push(e.data)})),e.addEventListener("stop",(()=>{this.sourse=URL.createObjectURL(this.chunks[0]);const e=`<video width = '300' height = '200' controls src = '${this.sourse}'> </video>`;this.getPosition(),setTimeout((()=>{this.createTextMessage(e,this.position.latitude,this.position.longtitude)}),4e3)})),e.start(),this.audioRecorder.querySelector(".save-record").addEventListener("click",(()=>{this.audioRecorder.remove(),e.stop()}))}}).init()})();